CANステートマシンおよびCAN未受信タイムアウト設計書
==================================================

1. 目的
--------------------------------------------------
本設計は、ECUの動作状態に応じてCAN通信の未受信を監視し、
制御継続が危険と判断される場合に安全側（ERROR状態）へ遷移させることを目的とする。

本設計におけるタイムアウト監視は、
CAN通信プロトコル仕様そのものの監視ではなく、
制御状態における入力欠落の検出を目的とする。


2. 前提条件
--------------------------------------------------
- ECUは起動（INIT）時点からCANバスに接続されている想定とする
- CANフレームはINIT状態から受信される可能性がある
- CAN受信の有無が異常かどうかは、ECUの状態に依存する
- 本設計では、状態ごとにCAN未受信の扱いを明確に定義する


3. ECU状態定義
--------------------------------------------------

STATE_INIT
- ECU起動直後の初期化状態
- 各種モジュールの初期化を行う
- CAN通信は受信している可能性がある
- CAN未受信は異常判定に使用しない

STATE_STANDBY
- 制御待機状態
- 制御動作は行っていない
- CAN通信は受信していても、未受信でも異常とはしない

STATE_ACTIVE
- 制御動作中状態
- 制御継続に必要なCAN入力を前提とする
- CAN未受信は異常とみなす

STATE_ERROR
- 異常検出後の安全状態
- 制御動作は停止している
- 追加の異常検出は行わない


4. CAN監視方針（状態別）
--------------------------------------------------

STATE_INIT
- CAN未受信を異常としない
- 理由：起動中は通信の安定性が保証されないため

STATE_STANDBY
- CAN未受信を異常としない
- 理由：制御を開始していないため、安全上の問題がない

STATE_ACTIVE
- CAN未受信を異常（FAULT）とする
- 理由：制御継続に必要な入力が失われたと判断するため

STATE_ERROR
- CAN未受信を監視対象外とする
- 理由：すでに異常状態であり、追い打ちの異常検出は不要なため


5. タイムアウト仕様
--------------------------------------------------
- 監視対象：STATE_ACTIVE 状態中のCAN受信
- タイムアウト時間：1000ms
- 判定方法：
  - CANイベント受信時にタイマをリセットする
  - STATE_ACTIVE 状態中にタイマが満了した場合、FAULTイベントを生成する
- 生成されたFAULTイベントはステートマシンへ通知される


6. 状態遷移仕様（抜粋）
--------------------------------------------------

STATE_INIT
- READY 受信時 → STATE_STANDBY へ遷移
- 上記以外のイベントは無視する

STATE_STANDBY
- START 受信時 → STATE_ACTIVE へ遷移
- RESET 受信時 → STATE_INIT へ遷移
- 上記以外のイベントは無視する

STATE_ACTIVE
- STOP 受信時 → STATE_STANDBY へ遷移
- FAULT 受信時 → STATE_ERROR へ遷移
- 上記以外のイベントは無視する

STATE_ERROR
- RESET 受信時 → STATE_INIT へ遷移
- RESET 以外のイベントは受け付けない
- READY / START / STOP / FAULT はすべて無視する


7. 責務分離
--------------------------------------------------

CAN通信層
- CANフレームの受信
- フレーム内容の妥当性チェック
- アプリケーションイベントへの変換

タイムアウト監視層
- CAN受信有無の時間管理
- タイムアウト検出
- FAULTイベントの生成

ステートマシン層
- イベントに基づく状態遷移
- 状態ごとの動作制御


8. 本設計の意図
--------------------------------------------------
本タイムアウト監視は、
CAN通信仕様違反の検出を目的としたものではなく、
制御動作中に必要な入力が途絶した場合に、
制御を継続できないと判断するための安全設計である。


9. 追跡性（トレーサビリティ）
--------------------------------------------------
- FAULTイベント発生時には以下の情報をログに残す
  - イベント発生源（ISR / TIMER）
  - イベント発生時のECU状態
  - 発生理由（CAN未受信タイムアウト）
- 本設計書と実装はGit上で同一コミットに含め、
  設計変更と実装変更の追跡性を確保する
